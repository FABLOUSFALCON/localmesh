// Package tui provides an interactive terminal dashboard for LocalMesh.
// Built with Bubble Tea and Lip Gloss for a btop-like experience.
package tui

import (
	"fmt"
	"strings"

	"github.com/charmbracelet/bubbles/help"
	"github.com/charmbracelet/bubbles/key"
	tea "github.com/charmbracelet/bubbletea"
	"github.com/charmbracelet/lipgloss"
)

// View represents different screens in the TUI
type View int

const (
	DashboardView View = iota
	ServicesView
	PluginsView
	NetworkView
	LogsView
	ConfigView
)

// Model is the main TUI model
type Model struct {
	// Current view
	currentView View

	// Window dimensions
	width  int
	height int

	// Data (will be populated from actual services)
	services []ServiceInfo
	nodes    []NodeInfo
	zones    []ZoneInfo
	logs     []LogEntry

	// UI components
	help     help.Model
	keymap   keyMap
	quitting bool
}

// ServiceInfo represents a service in the TUI
type ServiceInfo struct {
	Name    string
	Status  string // "running", "stopped", "degraded"
	Address string
	Port    int
}

// NodeInfo represents a mesh node
type NodeInfo struct {
	Name   string
	Host   string
	Status string // "online", "offline"
	Role   string // "gateway", "worker"
}

// ZoneInfo represents a network zone
type ZoneInfo struct {
	ID      string
	Name    string
	Clients int
}

// LogEntry represents a log line
type LogEntry struct {
	Time    string
	Service string
	Message string
	Level   string
}

// keyMap defines keyboard shortcuts
type keyMap struct {
	Up       key.Binding
	Down     key.Binding
	Left     key.Binding
	Right    key.Binding
	Tab      key.Binding
	Enter    key.Binding
	Services key.Binding
	Plugins  key.Binding
	Network  key.Binding
	Logs     key.Binding
	Config   key.Binding
	Help     key.Binding
	Quit     key.Binding
}

// ShortHelp returns keybindings for the mini help view
func (k keyMap) ShortHelp() []key.Binding {
	return []key.Binding{k.Help, k.Quit}
}

// FullHelp returns keybindings for the full help view
func (k keyMap) FullHelp() [][]key.Binding {
	return [][]key.Binding{
		{k.Up, k.Down, k.Left, k.Right},
		{k.Services, k.Plugins, k.Network, k.Logs},
		{k.Help, k.Quit},
	}
}

var defaultKeyMap = keyMap{
	Up: key.NewBinding(
		key.WithKeys("up", "k"),
		key.WithHelp("‚Üë/k", "up"),
	),
	Down: key.NewBinding(
		key.WithKeys("down", "j"),
		key.WithHelp("‚Üì/j", "down"),
	),
	Left: key.NewBinding(
		key.WithKeys("left", "h"),
		key.WithHelp("‚Üê/h", "left"),
	),
	Right: key.NewBinding(
		key.WithKeys("right", "l"),
		key.WithHelp("‚Üí/l", "right"),
	),
	Tab: key.NewBinding(
		key.WithKeys("tab"),
		key.WithHelp("tab", "switch panel"),
	),
	Enter: key.NewBinding(
		key.WithKeys("enter"),
		key.WithHelp("enter", "select"),
	),
	Services: key.NewBinding(
		key.WithKeys("s"),
		key.WithHelp("s", "services"),
	),
	Plugins: key.NewBinding(
		key.WithKeys("p"),
		key.WithHelp("p", "plugins"),
	),
	Network: key.NewBinding(
		key.WithKeys("n"),
		key.WithHelp("n", "network"),
	),
	Logs: key.NewBinding(
		key.WithKeys("l"),
		key.WithHelp("l", "logs"),
	),
	Config: key.NewBinding(
		key.WithKeys("c"),
		key.WithHelp("c", "config"),
	),
	Help: key.NewBinding(
		key.WithKeys("?"),
		key.WithHelp("?", "help"),
	),
	Quit: key.NewBinding(
		key.WithKeys("q", "ctrl+c"),
		key.WithHelp("q", "quit"),
	),
}

// Styles
var (
	// Colors
	primaryColor   = lipgloss.Color("#7C3AED") // Purple
	secondaryColor = lipgloss.Color("#10B981") // Green
	warningColor   = lipgloss.Color("#F59E0B") // Yellow
	dangerColor    = lipgloss.Color("#EF4444") // Red
	mutedColor     = lipgloss.Color("#6B7280") // Gray

	// Base styles
	titleStyle = lipgloss.NewStyle().
			Bold(true).
			Foreground(lipgloss.Color("#FFFFFF")).
			Background(primaryColor).
			Padding(0, 1)

	statusOnline = lipgloss.NewStyle().
			Foreground(secondaryColor).
			Bold(true)

	statusOffline = lipgloss.NewStyle().
			Foreground(dangerColor).
			Bold(true)

	statusDegraded = lipgloss.NewStyle().
			Foreground(warningColor).
			Bold(true)

	boxStyle = lipgloss.NewStyle().
			Border(lipgloss.RoundedBorder()).
			BorderForeground(primaryColor).
			Padding(0, 1)

	headerStyle = lipgloss.NewStyle().
			Bold(true).
			Foreground(primaryColor).
			MarginBottom(1)

	helpStyle = lipgloss.NewStyle().
			Foreground(mutedColor)
)

// New creates a new TUI model
func New() Model {
	return Model{
		currentView: DashboardView,
		help:        help.New(),
		keymap:      defaultKeyMap,
		// Mock data for demonstration
		services: []ServiceInfo{
			{Name: "attendance", Status: "running", Address: "10.0.1.5", Port: 8081},
			{Name: "lecture", Status: "running", Address: "10.0.1.5", Port: 8082},
			{Name: "notices", Status: "degraded", Address: "10.0.1.6", Port: 8083},
		},
		nodes: []NodeInfo{
			{Name: "main-gateway", Host: "10.0.1.5", Status: "online", Role: "gateway"},
			{Name: "cs-node-01", Host: "10.0.1.6", Status: "online", Role: "worker"},
			{Name: "mech-node-01", Host: "10.0.1.7", Status: "offline", Role: "worker"},
		},
		zones: []ZoneInfo{
			{ID: "general", Name: "General Campus", Clients: 12},
			{ID: "cs-department", Name: "CS Department", Clients: 8},
			{ID: "mech-department", Name: "Mech Dept", Clients: 3},
		},
		logs: []LogEntry{
			{Time: "19:32:45", Service: "attendance", Message: "Student marked present (CS101)", Level: "info"},
			{Time: "19:32:41", Service: "lecture", Message: "New session started: Data Structures", Level: "info"},
			{Time: "19:32:38", Service: "gateway", Message: "Node cs-node-01 joined the mesh", Level: "info"},
		},
	}
}

// Init initializes the model
func (m Model) Init() tea.Cmd {
	return nil
}

// Update handles messages
func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
	switch msg := msg.(type) {
	case tea.KeyMsg:
		switch {
		case key.Matches(msg, m.keymap.Quit):
			m.quitting = true
			return m, tea.Quit
		case key.Matches(msg, m.keymap.Services):
			m.currentView = ServicesView
		case key.Matches(msg, m.keymap.Plugins):
			m.currentView = PluginsView
		case key.Matches(msg, m.keymap.Network):
			m.currentView = NetworkView
		case key.Matches(msg, m.keymap.Logs):
			m.currentView = LogsView
		case key.Matches(msg, m.keymap.Config):
			m.currentView = ConfigView
		case msg.String() == "d":
			m.currentView = DashboardView
		}

	case tea.WindowSizeMsg:
		m.width = msg.Width
		m.height = msg.Height
		m.help.Width = msg.Width
	}

	return m, nil
}

// View renders the UI
func (m Model) View() string {
	if m.quitting {
		return "Goodbye! üëã\n"
	}

	var content string
	switch m.currentView {
	case DashboardView:
		content = m.dashboardView()
	case ServicesView:
		content = m.servicesView()
	case NetworkView:
		content = m.networkView()
	case LogsView:
		content = m.logsView()
	default:
		content = m.dashboardView()
	}

	return content
}

func (m Model) dashboardView() string {
	// Header
	header := titleStyle.Render(" LocalMesh Dashboard ") +
		"  " +
		statusOnline.Render("‚óè Online") +
		"  v0.1.0"

	// Services panel
	servicesContent := headerStyle.Render("üì¶ Services") + "\n"
	for _, s := range m.services {
		status := "üü¢"
		if s.Status == "stopped" {
			status = "üî¥"
		} else if s.Status == "degraded" {
			status = "üü°"
		}
		servicesContent += fmt.Sprintf("  %s %-12s %s:%d\n", status, s.Name, s.Address, s.Port)
	}
	servicesBox := boxStyle.Width(35).Render(servicesContent)

	// Zones panel
	zonesContent := headerStyle.Render("üåê Network Zones") + "\n"
	for _, z := range m.zones {
		zonesContent += fmt.Sprintf("  üìç %-15s %2d clients\n", z.Name, z.Clients)
	}
	zonesBox := boxStyle.Width(30).Render(zonesContent)

	// Nodes panel
	nodesContent := headerStyle.Render("üñ•Ô∏è  Nodes") + "\n"
	for _, n := range m.nodes {
		status := "üü¢"
		if n.Status == "offline" {
			status = "‚ö´"
		}
		nodesContent += fmt.Sprintf("  %s %-14s %s\n", status, n.Name, n.Host)
	}
	nodesBox := boxStyle.Width(35).Render(nodesContent)

	// Quick actions panel
	actionsContent := headerStyle.Render("‚ö° Quick Actions") + "\n"
	actionsContent += "  [s] Services\n"
	actionsContent += "  [p] Plugins\n"
	actionsContent += "  [n] Network\n"
	actionsContent += "  [l] Logs\n"
	actionsContent += "  [c] Config\n"
	actionsContent += "  [q] Quit"
	actionsBox := boxStyle.Width(30).Render(actionsContent)

	// Logs panel
	logsContent := headerStyle.Render("üìú Recent Activity") + "\n"
	for _, l := range m.logs {
		logsContent += fmt.Sprintf("  %s  %-12s %s\n", l.Time, l.Service, l.Message)
	}
	logsBox := boxStyle.Width(68).Render(logsContent)

	// Layout
	topRow := lipgloss.JoinHorizontal(lipgloss.Top, servicesBox, "  ", zonesBox)
	middleRow := lipgloss.JoinHorizontal(lipgloss.Top, nodesBox, "  ", actionsBox)

	// Help
	helpText := helpStyle.Render("[d]ashboard ‚Ä¢ [s]ervices ‚Ä¢ [p]lugins ‚Ä¢ [n]etwork ‚Ä¢ [l]ogs ‚Ä¢ [c]onfig ‚Ä¢ [q]uit")

	return lipgloss.JoinVertical(
		lipgloss.Left,
		header,
		"",
		topRow,
		"",
		middleRow,
		"",
		logsBox,
		"",
		helpText,
	)
}

func (m Model) servicesView() string {
	header := titleStyle.Render(" Services ")

	content := headerStyle.Render("Registered Services") + "\n\n"

	// Table header
	content += fmt.Sprintf("  %-4s %-15s %-10s %-20s\n",
		"", "NAME", "STATUS", "ADDRESS")
	content += "  " + strings.Repeat("‚îÄ", 55) + "\n"

	for _, s := range m.services {
		var statusIcon, statusText string
		switch s.Status {
		case "running":
			statusIcon = "üü¢"
			statusText = statusOnline.Render("running")
		case "stopped":
			statusIcon = "üî¥"
			statusText = statusOffline.Render("stopped")
		case "degraded":
			statusIcon = "üü°"
			statusText = statusDegraded.Render("degraded")
		}
		content += fmt.Sprintf("  %-4s %-15s %-10s %s:%d\n",
			statusIcon, s.Name, statusText, s.Address, s.Port)
	}

	helpText := helpStyle.Render("[d] back to dashboard ‚Ä¢ [q] quit")

	return lipgloss.JoinVertical(
		lipgloss.Left,
		header,
		"",
		content,
		"",
		helpText,
	)
}

func (m Model) networkView() string {
	header := titleStyle.Render(" Network & Zones ")

	// Nodes section
	nodesContent := headerStyle.Render("üñ•Ô∏è  Mesh Nodes") + "\n\n"
	nodesContent += fmt.Sprintf("  %-4s %-15s %-15s %-10s\n",
		"", "NAME", "HOST", "ROLE")
	nodesContent += "  " + strings.Repeat("‚îÄ", 50) + "\n"

	for _, n := range m.nodes {
		status := "üü¢"
		if n.Status == "offline" {
			status = "‚ö´"
		}
		nodesContent += fmt.Sprintf("  %-4s %-15s %-15s %-10s\n",
			status, n.Name, n.Host, n.Role)
	}

	// Zones section
	zonesContent := headerStyle.Render("üåê Network Zones") + "\n\n"
	zonesContent += fmt.Sprintf("  %-20s %-20s %s\n",
		"ID", "NAME", "CLIENTS")
	zonesContent += "  " + strings.Repeat("‚îÄ", 50) + "\n"

	for _, z := range m.zones {
		zonesContent += fmt.Sprintf("  %-20s %-20s %d\n",
			z.ID, z.Name, z.Clients)
	}

	helpText := helpStyle.Render("[d] back to dashboard ‚Ä¢ [q] quit")

	return lipgloss.JoinVertical(
		lipgloss.Left,
		header,
		"",
		nodesContent,
		"",
		zonesContent,
		"",
		helpText,
	)
}

func (m Model) logsView() string {
	header := titleStyle.Render(" Logs ")

	content := headerStyle.Render("üìú Activity Log") + "\n\n"
	content += fmt.Sprintf("  %-10s %-15s %s\n",
		"TIME", "SERVICE", "MESSAGE")
	content += "  " + strings.Repeat("‚îÄ", 70) + "\n"

	for _, l := range m.logs {
		content += fmt.Sprintf("  %-10s %-15s %s\n",
			l.Time, l.Service, l.Message)
	}

	helpText := helpStyle.Render("[d] back to dashboard ‚Ä¢ [q] quit")

	return lipgloss.JoinVertical(
		lipgloss.Left,
		header,
		"",
		content,
		"",
		helpText,
	)
}

// Run starts the TUI
func Run() error {
	p := tea.NewProgram(New(), tea.WithAltScreen())
	_, err := p.Run()
	return err
}
